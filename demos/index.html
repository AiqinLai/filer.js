<!DOCTYPE html>
<!--
Copyright 2011 - Eric Bidelman

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

Author: Eric Bidelman (ebidel@gmail.com)
-->
<html>
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="chrome=1" />
<title>HTML5 Filesystem Playground</title>
<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans" type="text/css" />
<link rel="stylesheet" href="css/app.css" type="text/css" />
</head>
<body>
<section>
  <h1>HTML5 <a href="http://www.html5rocks.com/tutorials/file/filesystem/" target="_blank">Filesystem</a> Playground</h1>
  <div style="margin-bottom:10px;">
    <button id="openFsButton">Open file system</button>
    <input type="text" id="dir-name" placeholder="directory name" value="myDir"/>
    <button onclick="mkdir(document.querySelector('#dir-name').value)">New directory</button>
    <input type="text" id="file-name" placeholder="file name" value="newFile.wav"/>
    <button onclick="newFile(document.querySelector('#file-name').value)">New file</button>
    <!--progress id="progress" value="0" min="0" max="100"></progress>-->
    <input type="checkbox" onclick="document.querySelector('#log').classList.toggle('active')" id="toggle-log"><label for="toggle-log">Show log</label>
  </div>
  <div style="font-size:small;display:inline-block">
     Display as: <a href="javascript:" onclick="display(this, 'list')">list</a> | <a href="javascript:" onclick="display(this, 'large')">icons</a>
  </div>
  <div style="float:right">Double-click on a file/folder name to rename it.</div>
  <div id="files" class="large"><ul></ul></div>
  <div id="file-info"></div>
</section>
<section>
  <div id="log">
    <button onclick="logger.clear()">Clear</button>
    <div></div>
  </div>
</section>

<script src="js/logger.js"></script>
<script src="js/dnd.js"></script>
<script src="../src/filer.js"></script>
<script>
var logger = new Logger('#log div');
var dnd = new DnDFileController('body', function(files) {
  Utils.toArray(files).forEach(function(file, i) {
    writeFile(file);
  });
});

var filer = new Filer();

var entries = []; // Cache of current working directory's entries.

// =============================================================================
var filePreview = document.querySelector('#file-info');
var filesContainer = document.querySelector('#files');
var fileList = filesContainer.querySelector('ul');
var openFsButton = document.querySelector('#openFsButton');

openFsButton.addEventListener('click', function(e) {
  if (filer && !filer.isOpen) {
    openFS();
  } else {
    this.textContent = 'Refresh folder';
  }
}, false);

function onError(e) {
  logger.log('<p class="error">' + e.name + '</p>');
}

function display(el, type) {
  if (type == 'list') {
    filesContainer.classList.remove('large');
  } else {
    filesContainer.classList.add('large');
  }
}

function toggleContentEditable(el) {
  if (el.isContentEditable) {
    el.removeAttribute('contenteditable');
  } else {
    el.setAttribute('contenteditable', '');
    el.focus();
  }
}

document.addEventListener('keydown', function(e) {
  var target = e.target;

  if (e.keyCode == 27) { // ESC
    filePreview.classList.remove('show');
    filePreview.innerHTML = '';
    e.preventDefault();
    e.stopPropagation();
  }

  // Prevent enter key from inserting carriage return in the contenteditable
  // file/folder renaming.
  if (target.isContentEditable && 'filename' in target.dataset) {
    if (e.keyCode == 13) {
      e.preventDefault();
      e.stopPropagation();
      target.blur();
    }
  }
}, false);


function constructEntryHTML(entry, i) {
  var img = entry.isDirectory ?
      '<img src="images/icons/folder.png" class="folder" onclick="cd(' + i + ')" title="Open folder" alt="Open folder">' :
      '<img src="images/icons/file.png" class="file" onclick="openFile(' + i + ')" title="Open file" alt="Open file">';

  var html = [img, '<div data-filename ondblclick="toggleContentEditable(this)" onblur="rename(this, ', i, ')">',
              entry.name, '</div>'];

  if (entry.isFile) {
    html.push('<a href="javascript:" onclick="readFile(', i, ')"><img src="images/icons/library.png" class="icon" title="Read file" alt="Read file"></a>');
    html.push('<a href="', entry.toURL(), '" download><img src="images/icons/download.png" class="icon" title="Download" alt="Download"></a>');
  }

  html.push('<a href="javascript:" onclick="remove(this,', i, ');"><img src="images/icons/trash_empty.png" class="icon" title="Remove" alt="Remove"></a>');

  return html.join('');
}

function addEntryToList(entry, opt_idx) {
  var idx = (opt_idx === undefined) ? entries.length - 1 : opt_idx;

  var li = document.createElement('li');
  li.innerHTML = constructEntryHTML(entry, idx);
  fileList.appendChild(li);
}

function renderEntries(resultEntries) {
  entries = resultEntries; // Cache the result set.

  fileList.innerHTML = ''; // Clear out existing entries and reset HTML.

  var li = document.createElement('li');
  li.innerHTML = '<a href="javascript:" onclick="cd(-1)" class="parentDir">' + 
      '<img src="images/icons/folder.png" class="folder">' + 
      '[ parent directory ]</a>';
  fileList.appendChild(li);

  if (!resultEntries.length) {
    var li = document.createElement('li');
    li.innerHTML = 'No files.'
    fileList.appendChild(li);
    return;
  }

  resultEntries.forEach(function(entry, i) {
    /*entry.getMetadata(function(e) {
    console.log(e)
    }, onError);*/
    addEntryToList(entry, i);
  });
}

function openFS() {
  filer.init({persistent: false, size: 1024 * 1024}, function(fs) {
    logger.log(fs.root.toURL())
    filer.ls('.', function(entries) {
      renderEntries(entries);
      logger.log('<p>Opened: ' + fs.name, + '</p>');

      var evt = document.createEvent('Event');
      evt.initEvent('click', false, false);
      openFsButton.dispatchEvent(evt);
    }, onError);
  }, onError);
}

function mkdir(name) {
  if (!name) return;

  try {
    filer.mkdir(name, true, addEntryToList, onError);
  } catch(e) {
    logger.log('<p class="error">' + e + '</p>');
  }
}

function cd(i) {
  if (i == -1) {
    var path = '..';
  } else {
    var path = entries[i].fullPath;
  }

  filer.ls(path, renderEntries, onError);
}

function openFile(i) {
  filer.open(entries[i].name);
}

function newFile(name) {
  if (!name) return;

  try {
    filer.create(name, true, addEntryToList, onError);
  } catch(e) {
    logger.log('<p class="error">' + e + '</p>');
  }
}

function writeFile(file) {
  if (!file) return;

  filer.write(file.name, {data: file, type: file.type},
    function(fileEntry, fileWriter) {
//console.log(fileEntry, fileWriter);
      addEntryToList(fileEntry);
      filer.ls('.', renderEntries, onError); // Just re-read this dir.
    },
    onError
  );
}

function rename(el, i) {
  filer.rename(entries[i], el.textContent, function(entry) {
    logger.log('<p>' + entries[i].name + ' renamed to ' + entry.name + '</p>');
    entries[i] = entry;

    // Fill download link with updated filsystem URL.
    el.parentElement.querySelector('[download]').href = entry.toURL();
  });
  toggleContentEditable(el);
}

function remove(link, i) {
  var entry = entries[i];

  if (!confirm('Delete ' + entry.name + '?')) {
    return;
  }

  filer.rm(entry, function() {
    var li = link.parentNode;
    li.classList.add('fadeout');
    li.addEventListener('webkitTransitionEnd', function(e) {
      this.parentNode.removeChild(this);
      filer.ls('.', renderEntries, onError); // Just re-read this dir.
    }, false);
  }, onError);
}

function copy(el, i) {
  filer.cp(entries[i], el.textContent, function(entry) {
    logger.log('<p>' + entries[i].name + ' renamed to ' + entry.name + '</p>');
    entries[i] = entry;
  });
  toggleContentEditable(el);
}

function readFile(i) {
  var entry = entries[i];

  try {
    filer.open(entry.name, function(file) {

      filePreview.classList.toggle('show');

      filePreview.innerHTML = [
        '<div><b>', file.name, '</b> ',
        (file.type ? '(' + file.type + ')' : ''), ' - ', file.size,
        ' bytes, modified: ', file.lastModifiedDate.toLocaleDateString(),
        '</div>'].join('');

      if (file.type.match(/audio.*/)) {
        var player = document.createElement('audio');
        player.controls = true;
        player.src = entry.toURL();

        filePreview.appendChild(player);

        player.load();
        player.play();

      } else if (file.type.match(/text.*/)) {

        var iframe = document.createElement('iframe');
        iframe.src = entry.toURL();

        filePreview.appendChild(iframe);

      } else if (file.type.match(/image.*/)) {

        var img = document.createElement('img');
        img.src = entry.toURL();

        filePreview.appendChild(img);
      } else {
        var p = document.createElement('p');
        p.textContent = 'No preview.'
        filePreview.appendChild(p);
      }

    }, onError);
  } catch(e) {
    logger.log('<p class="error">' + e + '</p>');
  }
}

openFS();
</script>
<!--[if IE]>
  <script src="http://ajax.googleapis.com/ajax/libs/chrome-frame/1/CFInstall.min.js"></script>
  <script>CFInstall.check({mode: 'overlay'});</script>
<![endif]-->
</body>
</html>